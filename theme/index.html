<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
        <title>Who Have I Been Talking to</title>
        
        <script type="text/javascript" src="libs/protovis-3.2/protovis-d3.2.js"></script>
        
        <script type="text/javascript" src="libs/jquery/jquery-1.5.2.min.js"></script>
        
        <script type="text/javascript" src="libs/jqcloud/jqcloud/jqcloud-0.1.5.js"></script>
        <link rel="stylesheet" type="text/css" href="libs/jqcloud/jqcloud/jqcloud.css" />
        
        <script src="libs/tipsy/src/javascripts/jquery.tipsy.js" type="text/javascript"></script>
        <script src="libs/tipsy/src/javascripts/tipsy.js" type="text/javascript"></script>
        <link href="libs/tipsy/src/stylesheets/tipsy.css" type="text/css" rel="stylesheet"/>
        
        
        <link rel="stylesheet" href="libs/jquery-ui/development-bundle/themes/base/jquery.ui.all.css"> 
		<script src="libs/jquery-ui/js/jquery-ui-1.8.12.custom.min.js"></script> 

		
        
        <link rel="stylesheet" type="text/css" href="theme.css" />
        
        <style type="text/css">
        
            .tipsy, .ui-menu .ui-menu-item a { 
                font-size: 12px !important; 
            }
            
            .tipsy-inner {
                text-align:left;
            }
            
            input#search {
                border-radius: 0px;
                border-top-left-radius: 5px;
                border-bottom-left-radius: 5px;
                
                font-size: 14px !important;
                
                padding: 2px 10px 2px 10px;
                -webkit-appearance: none;
				width:150px;
				height:24px;
            }
            
            button#search {
                background-color: #222;
                background-image: -moz-linear-gradient(top, rgba(255, 255, 255, .25), rgba(255, 255, 255, .11));
                background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0, rgba(255, 255, 255, .25)),color-stop(1, rgba(255, 255, 255, .11)));
                background-image: -webkit-linear-gradient(rgba(255, 255, 255, .25), rgba(255, 255, 255, .11));
                color: white;
                text-rendering: optimizeLegibility;
                //text-shadow: 0 -1px 1px #222;
                padding: 2px 10px 2px 10px;
                border: 0;
                border-radius: 0;
                border-bottom: 1px solid #222;
                //margin: 0;
                //-moz-box-shadow: 0 1px 3px #999;
                //-webkit-box-shadow: 0 1px 3px #999;
                
                /*
                -moz-box-shadow: 0 0 5px #888;
                -webkit-box-shadow: 0 0 5px#888;
                box-shadow: 0 0 5px #888;
                */
            
                border-top-right-radius: 5px;
                border-bottom-right-radius: 5px;
                margin-left:2px;
            }
            
            .w0, .w1, .w2, .w3, .w4, .w5, .w6, .w7, .w8, .w9, .w10 {
                cursor:pointer;
            }
            
            .selectedWord {
                font-weight: bold;
                color:#222 !important;
            }
            
            #tagCloud span.w10, #tagCloud span.w9, #tagCloud span.w8, #tagCloud span.w7 {
                text-shadow: 0px 1px 1px #ccc;
            }
            
            #tagCloud span.w3, #tagCloud span.w2, #tagCloud span.w1 {
                text-shadow: 0px 1px 1px #fff;
            }
            
        </style>
    </head>
  
    <body>
    
        <script type="text/javascript+protovis">
            if(true)
            {
                
                var defaultHue = 0;
                var defaultSaturation = 49;
                
                minLuminance = 30;
                maxLuminance = 90;
                
                var unselectedDefaultHue = 0;
                var unselectedDefaultSaturation = 0;
                
                /*
                var defaultHue = 243;
                var defaultSaturation = 10;
                
                minLuminance = 30;
                maxLuminance = 90;
                */
                
                var colorsForSelectedContacts = [{h:36, s:100, l:50}, {h:48, s:100, l:50}, {h:120, s:33, l:70}];
            } else 
            {
                var defaultHue = 360;
                var defaultSaturation = 69;
                
                var unselectedDefaultHue = 0;
                var unselectedDefaultSaturation = 0;
                
                minLuminance = 50;
                maxLuminance = 90;
                
                var colorsForSelectedContacts = ["#6D98AB", "#F68B1F", "#74c476"];
            }
            
            var selectedContacts = [];
            var selectedContactsNames = [];
            
            var selectedWords = [];
            
            var labelOffset = 10;
            
            var colorsForSelectedContactsStatic = colorsForSelectedContacts.slice();
            
            function getColorsForSelectedContact(index)
            {
                var colorArray = colorsForSelectedContacts[index];
                return "hsl(" + colorArray.h + ", " + colorArray.s + "%%, " + colorArray.l + "%%)";
             
            }
            
            function getBarHeight(data, maxHeight)
            {
                return data.value * (maxHeight/2 - 2.5*labelOffset);
            }
            
            function getColor(bar)
            {
             
                function blendWithBackground(colorHue, colorSaturation, colorLuminance)
                {
                    var factor2 = (1.0-opacity);
                    if(factor2 < 0)
                        factor2 = - factor2;
                    var hue = colorHue*opacity + 0*factor2;
                    var saturation = colorSaturation*opacity + 0*factor2;
                    var luminance = colorLuminance*opacity + 93*factor2;
                    return "hsl("+hue+","+saturation+"," + luminance +")";
                }
                
                var opacity = 1.0;
                loop1:
                for(var i in selectedWords)
                {
                    var opacity = 0.1;
                    var selectedWord = selectedWords[i];
                    if(bar.words != undefined)
                    {
                        for(var j in bar.words)
                        {
                            var senderWords = bar.words[j];
                            if((index = senderWords.indexOf(selectedWord)) != -1)
                            {
                                var opacity = 1.0;
                                break loop1;
                            }
                        }
                    }
                }
                if(selectedContacts.length == 0)
                {
                    return blendWithBackground(defaultHue, defaultSaturation, bar.luminance);
                }
                var selectedContactIndexes = [];
                for(var i in bar.name)
                {
                    sender = getAddress(bar.name[i]);
                    if((index = getContactSelectedIndex(sender)) != -1)
                    {
                        selectedContactIndexes.push(index);
                    }
                }
                if(selectedContactIndexes.length == 0)
                {
                    return blendWithBackground(unselectedDefaultHue, unselectedDefaultSaturation, bar.luminance);
                } else if(selectedContactIndexes.length == 1)
                {
                    var colorStruct =  colorsForSelectedContacts[selectedContactIndexes[0]];
                    return blendWithBackground(colorStruct.h, colorStruct.s, colorStruct.l);
                    return getColorsForSelectedContact(selectedContactIndexes[0]);
                } else 
                {
                    return blendWithBackground(defaultHue, defaultSaturation, bar.luminance);
                }  
            }
            
            function getColor2(bar)
            {
                for(var i in selectedWords)
                {
                    var selectedWord = selectedWords[i];
                    if(bar.words != undefined)
                    {
                        for(var j in bar.words)
                        {
                            var senderWords = bar.words[j];
                            if((index = senderWords.indexOf(selectedWord)) != -1)
                            {
                                var factor = 0.4;
                                var factor2 = (1-factor);
                                if(factor2 < 0)
                                    factor2 = - factor2;
                                var hue = defaultHue*factor + 0*factor2;
                                var saturation = defaultSaturation*factor + 0*factor2;
                                var luminance = bar.luminance*factor + 93*factor2
                                return "hsl("+hue+","+saturation+"," + luminance +")";
                            }
                        }
                    }
                }
                
                if(selectedContacts.length == 0)
                {
                    return "hsl("+defaultHue+","+defaultSaturation+"," + bar.luminance +")";
                }
                var selectedContactIndexes = [];
                for(var i in bar.name)
                {
                    sender = getAddress(bar.name[i]);
                    if((index = getContactSelectedIndex(sender)) != -1)
                    {
                        selectedContactIndexes.push(index)
                    }
                }
                if(selectedContactIndexes.length == 0)
                {
                    return "hsl("+unselectedDefaultHue+","+unselectedDefaultSaturation+","+bar.luminance+")";
                } else if(selectedContactIndexes.length == 1)
                {
                    return getColorsForSelectedContact(selectedContactIndexes[0]);
                } else 
                {
                    return "hsl("+defaultHue+","+defaultSaturation+"," + bar.luminance +")";
                }  
            }
            
            function getLuminances(data)
            {
                var maxHeight = document.getElementById("timeLine").clientHeight;
                max = i
                for(var i in data)
                {
                    barHeight = getBarHeight(data[i], maxHeight);
                    if(barHeight > 0)
                        max = i
                    else
                        break;
                }
                var luminances = [];
                if(selectedContacts.length == 0)
                {
                    for(var i in data)
                    {
                        var luminance = (maxLuminance - minLuminance)/(max + 1) * (i + 1) + minLuminance;
                        //var luminance = Math.log(i)/Math.log(max) * i + minLuminance;
                        luminances.push(luminance);
                    }
                } else 
                {
                    for(var i in data)
                    {
                        var luminance = (maxLuminance - minLuminance)/(max + 1) * (i + 1) + minLuminance;
                        luminances.push(luminance);
                    }
                }
                
                return luminances
            }

			function getMonth(num)
			{
				switch(num)
				{
					case 0:
						return "Jan";
					case 1:
						return "Feb";
					case 2:
						return "Mar";
					case 3:
						return "Apr";
					case 4:
						return "May";
					case 5:
						return "Jun";
					case 6:
						return "Jul";
					case 7:
						return "Aug";
					case 8:
						return "Sep";
					case 9:
						return "Oct";
					case 10:
						return "Nov";
					case 11:
						return "Dec";
					default:
						return "Error";
				}
			}
            
            function getTip(bar, type)
            {
                var names = "";
                for(var nameIndex in bar.name)
                {
                    if(names.length > 0)
                    {
                        if(nameIndex < bar.name.length - 1)
                        {
                            names += ", ";
                        }
                        else
                        {
                            names += " and ";
                        }
                     
                    }
                        
                    thisName = getNameOrAddress(bar.name[nameIndex]);
                    if(thisName.length >= 40 && (thisName.indexOf("@") != -1))
                    {
                        thisName = thisName.substring(0,34) + "(...)";
                    }
                    names += thisName;
                }
                if(type == "received")
                    return names + " sent you <b>" + bar.count + " emails</b>";
                 
                if(type == "sent")
                    return " You sent <b>" + bar.count + " emails</b> to " + names;
            }
            
            function getNameOrAddress(contact)
            {
                if(contact.indexOf("<") != -1)
                    return getName(contact);
                else
                    return getAddress(contact);
            }
            
            function getAddress(name)
            {
                if($.isArray(name))
                {
                    return name;
                }
                var sender = name;
                if(sender.indexOf("<") != -1)
                {
                    sender = sender.substring(sender.indexOf("<")+1,sender.indexOf(">"));
                }
                if(sender.indexOf("@") == -1)
                {
                    sender = contactNameToEmails[name];
                    if($.isArray(sender) && sender.length == 1) 
                        sender = sender[0];
                }
                return sender
            }

			function getName(name)
            {
                var sender = name;
				index = sender.indexOf("<");
                if(index != -1 && index != 0)
                {
                    sender = sender.substring(0,sender.indexOf("<") - 1);
                }
                return sender
            }
            
            
            function barClick(bar)
            {
                if(bar.name.length > 1)
                {
                    var content = "<p>Select</p>";
                    content += "<div id='names'>";
                    for(var i in bar.name)
                    {
                        var name = bar.name[i];
                        name = name.replace("<", "(");
                        name = name.replace(">", ")");
                        if(!isContactSelected(bar.name[i]))
                        {
                            var checked = "";
                        } 
                        else 
                        {
                            var checked = "checked='yes'";
                        }
                        content += "<input type='checkbox' id='names' name='names' " + checked + " value='" + bar.name[i] + "'  />" + name + "<br />"
                    }
                    content += "</div>"
                    $("#dialog-message").html(content);
                    $( "#dialog-message" ).dialog("open");
                } 
                else 
                {
                    contactSelected(bar.name[0])
                }
                
                return;
            }
            
			function drawContactNames(selectedContacts, selectedContactsNames)
			{
				selectedStr = "";
				for(i in selectedContacts)
				{
					contactForClick = selectedContactsNames[i] + " <" +  selectedContacts[i] + ">"
					selectedStr += "<div style=\"float: left; border:1px solid #ccc; margin-top:2px; border-radius: 5px;margin-left: 10px;\"><div id=\"emailadd\" title=\""
                    if($.isArray(selectedContacts[i]))
                    {
                        var contactEmails = selectedContacts[i].join("\n");
                    }
                    else
                    {
                        var contactEmails = selectedContacts[i];
                    }
                    selectedStr += contactEmails;
					selectedStr += "\" style=\"cursor: Default; float: left; padding-left:5px; color:";
					selectedStr += getColorsForSelectedContact(i);
					selectedStr += "\">";
					selectedStr += selectedContactsNames[i];
					selectedStr += "</div><div style=\"float:right; margin-left:5px; cursor: Pointer; padding-right:5px;color:";
					selectedStr += getColorsForSelectedContact(i);
                    
                    if($.isArray(selectedContacts[i]))
                        selectedStr += ";\" onclick='contactSearch(\"" + selectedContactsNames[i] + "\");'>|X</div></div>";
                    else
					   selectedStr += ";\" onclick='contactSearch(\"" + selectedContactsNames[i] + " <" +  selectedContacts[i] + ">\");'>|X</div></div>";
				}
				$("#selectedZone").html(selectedStr);

				
			}

			$('#emailadd').tipsy({live: true, fade: true});

			function orderColors()
			{
				indexOfStart = selectedContacts.length;
				changed = 0;
				while (indexOfStart < colorsForSelectedContacts.length - 1)
				{
					if (colorsForSelectedContactsStatic.indexOf(colorsForSelectedContacts[indexOfStart]) > colorsForSelectedContactsStatic.indexOf(colorsForSelectedContacts[indexOfStart + 1]))
					{
						aux = colorsForSelectedContacts[indexOfStart];
						colorsForSelectedContacts[indexOfStart] = colorsForSelectedContacts[indexOfStart + 1];
						colorsForSelectedContacts[indexOfStart + 1] = aux;
						changed = 1;
					}
					indexOfStart++;
				}
				if(changed)
				{
					orderColors();
				}
			}


            function isContactSelected(contact)
            {
                return getContactSelectedIndex(contact) != -1;
                /*
                sender = getAddress(contact);
                for(var i in selectedContacts)
                {
                    var selectedContact = selectedContacts[i];
                    var isArray = $.isArray(selectedContact);
                    if( (isArray && selectedContact.indexOf(sender) != -1) || (!isArray && selectedContact.indexOf(sender) != -1))
                    {
                        return true
                    }
                }
                return false
                */
                
                /*
                sender = getAddress(contact);
                return selectedContacts.indexOf(sender) != -1;
                */
            }
            
            function arrayMatch( a, b ) {
      var o = {};
      for( var i = a.length; --i >= 0; )
         o[ a[i] ] = true;
      for( var i = b.length; --i >= 0; )
         if( o[ b[i] ] )
            return true;
      return false;
   }
            
            function getContactSelectedIndex(contact)
            {
                sender = getAddress(contact);
                var isSenderAnArray = $.isArray(sender);
                for(var i in selectedContacts)
                {
                    var selectedContact = selectedContacts[i];
                    var isSelectedAnArray = $.isArray(selectedContact);
                
                    /*
                    alert(sender + " | " + selectedContact);
                    if((!isSenderAnArray && isSelectedAnArray) || (isSenderAnArray && !isSelectedAnArray)) // if one is array and the other no
                    {
                        alert("coiso");
                        continue;
                    }
                    */
                    
                    if(isSelectedAnArray)
                    {
                        if(isSenderAnArray && arrayMatch(selectedContact,sender))
                        {
                            return i;
                        }
                        else if(!isSenderAnArray && selectedContact.indexOf(sender) != -1)
                        {
                            return i;
                        }
                    }
                    else
                    {
                        if(isSenderAnArray && sender.indexOf(selectedContact) != -1)
                        {
                            return i;
                        }
                        else if(!isSenderAnArray && sender == selectedContact)
                        {
                            return i;
                        }
                    }
                    
                    /*
                    if(!isSelectedAnArray && selectedContact.indexOf(sender) != -1)
                    {
                        return i;
                    }
                    
                    if(isSelectedAnArray && arrayMatch(selectedContact,sender))
                    {
                        return i;
                    }
                    */
                    
                }
                return -1
            }
            
            function contactSelected(contact)
            {   
                sender = getAddress(contact);
				name = getName(contact);
                name = name.replace(/\"/g,' ');
                if(getContactSelectedIndex(sender) == -1)
                {   
                    if(selectedContacts.length == colorsForSelectedContacts.length)
                    {
                        alert("You can only select up to " + colorsForSelectedContacts.length + " contact at a time.");
                        return;
                    } else 
                    {
                        selectedContacts.push(sender);
						selectedContactsNames.push(name);
						drawContactNames(selectedContacts, selectedContactsNames);
                    }
                    
                } else 
                {
                    indAux = getContactSelectedIndex(sender);
					colorAux = colorsForSelectedContacts[indAux];
                    selectedContacts.splice(indAux,1);
					selectedContactsNames.splice(indAux,1);
					colorsForSelectedContacts.splice(indAux, 1);
					colorsForSelectedContacts.push(colorAux);
					drawContactNames(selectedContacts, selectedContactsNames);
					if(colorsForSelectedContacts.length - selectedContacts.length > 1)
					{
						orderColors();
					}
                }
                
                $("#tagCloud").html("");
                if(selectedContacts.length == 0)
                {
                    drawCloud(geralKeywords);
                } else 
                {
                    var words = [];
                    var wordsPosition = {};
                    for(var i in selectedContacts)
                    {   
                        if(! $.isArray(selectedContacts[i]))
                        {
                            var senders = [selectedContacts[i]];
                        }
                        else
                        {
                            var senders = selectedContacts[i];
                        }
                        
                        for(var j in senders)
                        {
                            var sender = getAddress(senders[j]);
                            var words = contactsKeywords[sender];
                            for(var w in word)
                            {
                                var word = word[w];
                                if((index = wordsPosition.indexOf(word)) == - 1)
                                {
                                    words.push(word);
                                    wordsPosition.push(word.text);
                                }
                                else
                                {
                                    words[index].weigh += word.weigh;
                                }
                            }
                        }
                    }
                    drawCloud(words);
                }
            }
            
            function wordSelected(word)
            {
                if((index = selectedWords.indexOf(word)) == -1)
                {
                    selectedWords.push(word);
                } else 
                {
                    selectedWords.splice(index,1);
                }
                $('.w0, .w1, .w2, .w3, .w4, .w5, .w6, .w7, .w8, .w9, .w10').each(function() {
                           
                                                                                            
                         if(selectedWords.length == 0 || selectedWords.indexOf($(this).html()) != -1)
                         {
                            $(this).css("opacity", "1.0");
                            if(selectedWords.length != 0)
                                $(this).addClass("selectedWord");
                            else
                                $(this).removeClass("selectedWord");
                         } else {
                             $(this).css("opacity", "0.2");
                             $(this).removeClass("selectedWord");
                         }                        
                     }
                 
                 );
                reRender();
            }
            
            function contactSearch(contact)
            {   
                //var address = getAddress(contact);
                contactSelected(contact);
                reRender();
            }
            
            function reRender(targets)
            {
                if( targets == undefined)
                {
                    targets = [vis, dailyVis];
                } else if(!$.isArray(targets))
                {
                    targets = [targets];
                }
                for(var i in targets)
                {
                    target = targets[i];
                    target.selectedContacts(getSelectedContacts());
                    target.selectedWords(getSelectedWords());
                    target.render();
                }
            }
            
            var minbarswidth = 25
            var maxbarswidth = 50
            var width = document.getElementById("timeLine").clientWidth;
            var height = document.getElementById("timeLine").clientHeight;
            var dailyWidth = document.getElementById("timeLine2-holder").clientWidth;
            var dailyHeight = document.getElementById("timeLine2-holder").clientHeight;
            var heightOverTwo = height/2;
            
            function getSelectedContacts()
            {
                return selectedContacts
            }
            
            function getSelectedWords()
            {
                return selectedWords;
            }
            
            var mouseDownFlag = false;
            
            function transform() {
                mouseDownFlag = true;
                var t = this.transform().invert();
                x.domain(t.x / w * 2 * kx - kx, (t.k + t.x / w) * 2 * kx - kx);
                y.domain(t.y / h * 2 * ky - ky, (t.k + t.y / h) * 2 * ky - ky);
                vis.render();
            }
            
            pv.Behavior.pan = function() {
              var scene, // scene context
                  index, // scene context
                  m1, // transformation matrix at the start of panning
                  v1, // mouse location at the start of panning
                  k, // inverse scale
                  bound; // whether to bound to the panel
            
              /** @private */
              function mousedown() {
                index = this.index;
                scene = this.scene;
                v1 = pv.vector(pv.event.pageX, pv.event.pageY);
                m1 = this.transform();
                k = 1 / (m1.k * this.scale);
                if (bound) {
                  bound = {
                    x: (1 - m1.k) * this.width(),
                    y: (1 - m1.k) * this.height()
                  };
                }
              }
            
              /** @private */
              function mousemove() {
                if (!scene) return;
                scene.mark.context(scene, index, function() {
                    var x = (pv.event.pageX - v1.x) * k,
                        y = (pv.event.pageY - v1.y) * k,
                        m = m1.translate(x, y);
                    if (bound) {
                      //m.x = Math.max(bound.x, Math.min(0, m.x));
                      m.y = Math.max(bound.y, Math.min(0, m.y));
                    }
                    var tolerance = 25;
                    m.x = Math.min(m.x, 0 + tolerance);
                    m.x = Math.max(m.x, this.width() - totalWidth - tolerance);
                    
                    this.transform(m).render();
                  });
                pv.Mark.dispatch("pan", scene, index);
              }
            
              /** @private */
              function mouseup() {
                scene = null;
              }
            
              /**
               * Sets or gets the bound parameter. If bounding is enabled, the user will not
               * be able to pan outside the initial panel bounds; this typically applies
               * only when the pan behavior is used in tandem with the zoom behavior.
               * Bounding is not enabled by default.
               *
               * <p>Note: enabling bounding after panning has already occurred will not
               * immediately reset the transform. Bounding should be enabled before the
               * panning behavior is applied.
               *
               * @function
               * @returns {pv.Behavior.pan} this, or the current bound parameter.
               * @name pv.Behavior.pan.prototype.bound
               * @param {boolean} [x] the new bound parameter.
               */
              mousedown.bound = function(x) {
                if (arguments.length) {
                  bound = Boolean(x);
                  return this;
                }
                return Boolean(bound);
              };
            
              pv.listen(window, "mousemove", mousemove);
              pv.listen(window, "mouseup", mouseup);
              return mousedown;
            };
            
            var totalWidth = 0;
            
            var leftPosition = $("#timeLine").offset().left;
            var rightPosition = leftPosition + $("#timeLine").outerWidth();
    
            function drawTimeLine(receivedData, sentData)
            {	
				numOfMonths = 0
				for(var i in receivedData)
				{
					numOfMonths += receivedData[i].months.length
				}
                var barswidth = width/numOfMonths;
                if (barswidth > maxbarswidth)
                {
                    barswidth = maxbarswidth;
                }
                else if (barswidth < minbarswidth)
                {
                    barswidth = minbarswidth;
                }
				
				var m = new pv.Transform();
				m.x = -(numOfMonths*barswidth - width);
				vis.transform(m);

				var barscount = 0;
                for (var j in receivedData)
				{
	                for(var i in receivedData[j].months)
    	            {
        	            var luminances = getLuminances(receivedData[j].months[i]);
        	
            	        var monthData = [];
                        var monthReceivedCount = 0;
                	    for(var k in receivedData[j].months[i])
                    	{
                        	monthData.push({value: receivedData[j].months[i][k].value, count: receivedData[j].months[i][k].count, name: receivedData[j].months[i][k].name, luminance: luminances[k], words:receivedData[j].months[i][k].words});
	                        monthReceivedCount += receivedData[j].months[i][k].count * receivedData[j].months[i][k].name.length;
                        }
    	                var minMonthIndex = receivedData[j].minMonth - 1; // minus 1 because minMonth is from 1 to 12 and we want the index
                       
                       vis
        	            .add(pv.Bar)
            	            .data(monthData)
                		    .fillStyle(function(d) getColor(d))
                            .bottom(heightOverTwo)
                        	.width(barswidth)
                        	.height(function(d) getBarHeight(d, height))
                        	.left(barscount * barswidth)
                            .event("click", function(d) mouseDownFlag ? (mouseDownFlag = false) : (barClick(d), window.setTimeout('reRender([dailyVis])', 100), this.parent.selectedContacts(getSelectedContacts())))
                            .event("mouseover", pv.Behavior.tipsy({rightPosition : rightPosition, gravity: "w", fade: true, html:true}))
                            .text(function(d) getTip(d, "received"))
                            .cursor("pointer")
                            ;	

                        
                        var luminances = getLuminances(sentData[j].months[i]);
            
                        var monthData = [];
                        var monthSentCount = 0;
                        for(var k in sentData[j].months[i])
                        {
                            monthData.push({value: sentData[j].months[i][k].value, count: sentData[j].months[i][k].count, name: sentData[j].months[i][k].name, luminance: luminances[k], words:sentData[j].months[i][k].words});
                            monthSentCount += sentData[j].months[i][k].count * sentData[j].months[i][k].name.length;
                        }
                        var minMonthIndex = sentData[j].minMonth - 1; // minus 1 because minMonth is from 1 to 12 and we want the index
                        
                        vis
                        .add(pv.Bar)
                            .data(monthData)
                            .fillStyle(function(d) getColor(d))
                            .top(heightOverTwo)
                            .width(barswidth)
                            .height(function(d) getBarHeight(d, height))
                            .left(barscount * barswidth)
                            .event("click", function(d) mouseDownFlag ? (mouseDownFlag = false) : (barClick(d), window.setTimeout('reRender([dailyVis])', 100), this.parent.selectedContacts(getSelectedContacts())))
                            .event("mouseover", pv.Behavior.tipsy({rightPosition : rightPosition, gravity: "w", fade: true, html:true}))
                            .text(function(d) getTip(d, "sent"))
                            .cursor("pointer")
                            ;
                        
						rule = vis.add(pv.Rule)
							.top(labelOffset)
							.height(height - labelOffset + 20)
							.left(barscount*barswidth);
	                    /*
						rule.add(pv.Label)
							.text(getMonth(parseInt(i) + minMonthIndex))
							.textAlign("left")
							.textBaseline("top");
                        */
                        
                        var monthName = getMonth(parseInt(i) + minMonthIndex);
                        var year = receivedData[j].year;
                        
                        rule.add(pv.Bar)
                            .def("month", parseInt(i) + minMonthIndex)
                            .def("year", year)
                            .width(barswidth/2)
                            .height(15)
                            .fillStyle("rgba(0,0,0,0.00001)")
                            .text(getMonth(parseInt(i) + minMonthIndex))
                            .event("click", function() monthClicked(this.month(), this.year()))
                            .text(monthReceivedCount + " emails received<br/>" + monthSentCount + " emails sent")
                            .event("mouseover", pv.Behavior.tipsy({gravity: "s", fade: true, html:true}))
                            .cursor("pointer")
                                .add(pv.Label)
                                .text(monthName)
                                .textAlign("left")
                                .textBaseline("top")
                            ;
                                
						barscount = barscount + 1;
        	
            	    }

                    if(j == 0)
                    {
                        rule = vis.add(pv.Rule)
                            .left(0);
                    }
					else
					{
						rule = vis.add(pv.Rule)
                            .left(((j-1)*barswidth*receivedData[j-1].months.length) + receivedData[0].months.length*barswidth);
					}
    				
					rule.add(pv.Label)
						.text(receivedData[j].year)
						.textAlign("left")
						.textBaseline("top")
                        ;
				}

				vis.add(pv.Rule)
    				.top(heightOverTwo)
                    .width(numOfMonths * barswidth);
                
                totalWidth = barscount*barswidth;
                vis.render();
            }


            function monthClicked(month, year)
            {
                dailyVisChildren = dailyVis.children;
                for(i in dailyVisChildren)
                {
                    dailyVisChildren[i].visible(false)
                }

                /*var str = "<div id=\"timeLine2\" style=\"width: 100%%; height: 100%%; border: 1px solid #ccc\"> \n";
                str += "<"
                str += "/div>"
                $('#timeLine2').replaceWith(str);
                str = "<script type=\"text/javascript+protovis\">\n";
                str += "dailyVis = new pv.Panel()\n"
                str += ".width(dailyWidth)\n"
                str += ".height(dailyHeight)\n"
                str += ".fillStyle(\"#EEE\")\n"
                str += ".event(\"mousedown\", (pv.Behavior.pan().bound(true)))\n"
                str += ".event(\"pan\", function() mouseDownFlag = true)\n"
                str += ".def(\"selectedContacts\", selectedContacts)\n"
                str += ".def(\"selectedWords\", selectedWords)\n"
                str += ";\n"
                str += "alert('ola');\n"
                str += "<"
                str += "/script>\n";
                $('#timeLine2').html(str)*/
                    
                drawDailyTimeLine(dailyReceivedTimeline, dailySentTimeline, month, year)
            }
            
            function drawDailyTimeLine(originalReceivedData, originalSentData, month, year)
            {    
                sentData = [];
                receivedData = [];
                
                yearIndex = 0;
                for(var i in originalReceivedData)
                {
                    if (year == originalReceivedData[i].year)
                    {
                        yearIndex = i;
                        break;
                    }
                }
                //If is the first month of the year
                if (month == originalReceivedData[yearIndex].minMonth - 1)
                {    //If is the first year
                    if(year == originalReceivedData[0].year)
                    {
                        receivedData.push({year: originalReceivedData[yearIndex].year, minMonth: originalReceivedData[yearIndex].minMonth, months: [originalReceivedData[yearIndex].months[0].slice()]});
                        sentData.push({year: originalSentData[yearIndex].year, minMonth: originalSentData[yearIndex].minMonth, months: [originalSentData[yearIndex].months[0].slice()]});
                        if(month == originalReceivedData[yearIndex].months.length + originalReceivedData[yearIndex].minMonth - 2) //last month of the year
                        {
                            if(yearIndex != originalReceivedData.length - 1)//not last year
                            {
                                receivedData.push({year: originalReceivedData[yearIndex + 1].year, minMonth: originalReceivedData[yearIndex + 1].minMonth, months: [originalReceivedData[yearIndex + 1].months[0].slice()]});
                                sentData.push({year: originalSentData[yearIndex + 1].year, minMonth: originalSentData[yearIndex + 1].minMonth, months: [originalSentData[yearIndex + 1].months[0].slice()]});
                            }
                        }
                        else
                        {
                            receivedData[0].months.push(originalReceivedData[yearIndex].months[1].slice());
                            sentData[0].months.push(originalSentData[yearIndex].months[1].slice());
                        }
                    }
                    else
                    {    
                        receivedData.push({year: originalReceivedData[yearIndex - 1].year, minMonth: 12, months: [originalReceivedData[yearIndex - 1].months[12-originalReceivedData[yearIndex - 1].minMonth].slice()]});
                        sentData.push({year: originalSentData[yearIndex - 1].year, minMonth: 12, months: [originalSentData[yearIndex - 1].months[originalSentData[yearIndex - 1].minMonth].slice()]});
                        receivedData.push({year: originalReceivedData[yearIndex].year, minMonth: 1, months: [originalReceivedData[yearIndex].months[0].slice()]});
                        sentData.push({year: originalSentData[yearIndex].year, minMonth: 1, months: [originalSentData[yearIndex].months[0].slice()]});
                        if(month == originalReceivedData[yearIndex].months.length - 1) //last month of the year
                        {
                            if(yearIndex != originalReceivedData.length - 1)//not last year
                            {
                                receivedData.push({year: originalReceivedData[yearIndex + 1].year, minMonth: originalReceivedData[yearIndex + 1].minMonth, months: [originalReceivedData[yearIndex + 1].months[0].slice()]});
                                sentData.push({year: originalSentData[yearIndex + 1].year, minMonth: originalSentData[yearIndex + 1].minMonth, months: [originalSentData[yearIndex + 1].months[0].slice()]});
                            }
                        }
                        else
                        {
                            receivedData[1].months.push(originalReceivedData[yearIndex].months[1].slice());
                            sentData[1].months.push(originalSentData[yearIndex].months[1].slice());
                        }
                    }
                }
                else if (month == originalReceivedData[yearIndex].months.length + originalReceivedData[yearIndex].minMonth - 2)
                {
                    receivedData.push({year: originalReceivedData[yearIndex].year, minMonth: month, months: [originalReceivedData[yearIndex].months[month - originalReceivedData[yearIndex].minMonth].slice()]});
                    sentData.push({year: originalSentData[yearIndex].year, minMonth: month, months: [originalSentData[yearIndex].months[month - originalSentData[yearIndex].minMonth].slice()]});

                    receivedData[0].months.push(originalReceivedData[yearIndex].months[month-originalReceivedData[yearIndex].minMonth + 1].slice());
                    sentData[0].months.push(originalSentData[yearIndex].months[month-originalSentData[yearIndex].minMonth + 1].slice());
                    
                    if(yearIndex != originalReceivedData.length - 1)//not last year
                    {
                        yearIndex = parseInt(yearIndex)
                        receivedData.push({year: originalReceivedData[yearIndex + 1].year, minMonth: originalReceivedData[yearIndex + 1].minMonth, months: [originalReceivedData[yearIndex + 1].months[0].slice()]});
                        sentData.push({year: originalSentData[yearIndex + 1].year, minMonth: originalSentData[yearIndex + 1].minMonth, months: [originalSentData[yearIndex + 1].months[0].slice()]});
                    }
                }
                else
                { 
                    receivedData.push({year: originalReceivedData[yearIndex].year, minMonth: month, months: [originalReceivedData[yearIndex].months[month - originalReceivedData[yearIndex].minMonth].slice()]});
                    sentData.push({year: originalSentData[yearIndex].year, minMonth: month, months: [originalSentData[yearIndex].months[month - originalSentData[yearIndex].minMonth].slice()]});

                    receivedData[0].months.push(originalReceivedData[yearIndex].months[month-originalReceivedData[yearIndex].minMonth + 1].slice());
                    sentData[0].months.push(originalSentData[yearIndex].months[month-originalSentData[yearIndex].minMonth + 1].slice());

                    receivedData[0].months.push(originalReceivedData[yearIndex].months[month - originalReceivedData[yearIndex].minMonth + 2].slice());
                    sentData[0].months.push(originalSentData[yearIndex].months[month - originalSentData[yearIndex].minMonth + 2].slice());

                }

                numOfDays = 0
                for(var i in receivedData)
                {
                    for(var j in receivedData[i].months)
                    {
                        numOfDays += receivedData[i].months[j].length
                    }
                }
                var barswidth = 20;
                var barscount = 0;
                var barscountbefore = 0;
                for (var j in receivedData)
                {
                    for(var x in receivedData[j].months)
                    {
                        for(var i in receivedData[j].months[x])
                        {
                            var luminances = getLuminances(receivedData[j].months[x][i]);
                            
                            var dayData = [];
                            
                            for(var k in receivedData[j].months[x][i])
                            {
                                dayData.push({value: receivedData[j].months[x][i][k].value, count: receivedData[j].months[x][i][k].count, name: receivedData[j].months[x][i][k].name, luminance: luminances[k], words:receivedData[j].months[x][i][k].words});
                            }
                            var minMonthIndex = receivedData[j].minMonth - 1; // minus 1 because minMonth is from 1 to 12 and we want the index

                           dailyVis
                            .add(pv.Bar)
                                .data(dayData)
                                .fillStyle(function(d) getColor(d))
                                .bottom(dailyHeight/2)
                                .width(barswidth)
                                .height(function(d) getBarHeight(d, dailyHeight))
                                .left(barscount * barswidth)
                                //.event("click", function(d) mouseDownFlag ? (mouseDownFlag = false) : (barClick(d), this.parent.selectedContacts(getSelectedContacts())))
                                .event("click", function(d) mouseDownFlag ? (mouseDownFlag = false) : (barClick(d), window.setTimeout('reRender([vis])', 100), this.parent.selectedContacts(getSelectedContacts())))
                                .event("mouseover", pv.Behavior.tipsy({rightPosition : rightPosition, gravity: "w", fade: true, html:true}))
                                .text(function(d) getTip(d, "received"))
                                ;
                        
                            var luminances = getLuminances(sentData[j].months[x][i]);
            
                            var dayData = [];
                            for(var k in sentData[j].months[x][i])
                            {
                                dayData.push({value: sentData[j].months[x][i][k].value, count: sentData[j].months[x][i][k].count, name: sentData[j].months[x][i][k].name, luminance: luminances[k], words:sentData[j].months[x][i][k].words});
                            }
                            var minMonthIndex = sentData[j].minMonth - 1; // minus 1 because minMonth is from 1 to 12 and we want the index
                        
                            dailyVis
                            .add(pv.Bar)
                                .data(dayData)
                                .fillStyle(function(d) getColor(d))
                                .top(dailyHeight/2)
                                .width(barswidth)
                                .height(function(d) getBarHeight(d, dailyHeight))
                                .left(barscount * barswidth)
                                //.event("click", function(d) mouseDownFlag ? (mouseDownFlag = false) : (barClick(d), this.parent.selectedContacts(getSelectedContacts())))
                                .event("click", function(d) mouseDownFlag ? (mouseDownFlag = false) : (barClick(d), window.setTimeout('reRender([vis])', 100), this.parent.selectedContacts(getSelectedContacts())))
                                .event("mouseover", pv.Behavior.tipsy({rightPosition : rightPosition, gravity: "w", fade: true, html:true}))
                                .text(function(d) getTip(d, "sent"))
                                ;

                            rule = dailyVis.add(pv.Rule)
                                .top(20)
                                .height(dailyHeight - 31)
                                .left(barscount*barswidth);

                            rule.add(pv.Label)
                                .text(parseInt(i)+1)
                                .textAlign("left")
                                .textBaseline("top");
    
                            barscount = barscount + 1;
                        }

                        rule = dailyVis.add(pv.Rule)
                                .left(barscountbefore*barswidth);
                        
                        barscountbefore = barscount;
                        
                        rule.add(pv.Label)
                            .text(getMonth(parseInt(x) + minMonthIndex) + " " + receivedData[j].year)
                            .textAlign("left")
                            .textBaseline("top");
                    }
                }
                dailyVis.add(pv.Rule)
                    .top(dailyHeight/2)
                    .width(numOfDays * barswidth);

                totalWidth = barscount*barswidth;
                
                m = new pv.Transform();
                monthLength = 0
                for(var i in receivedData)
                {
                    monthLength += receivedData[i].months.length;
                }
                if(monthLength == 2)
                {
                    if(!((receivedData[0].year == originalReceivedData[0].year) && (receivedData[0].minMonth == originalReceivedData[0].minMonth)) || month == receivedData[0].minMonth)
                    {
                        if(receivedData.length == 2)//different years
                        {
                            m.x = -(receivedData[0].months[0].length * barswidth) + (dailyWidth - receivedData[1].months[0].length * barswidth);
                        }
                        else
                        {
                            m.x = -(receivedData[0].months[0].length * barswidth) + (dailyWidth - receivedData[0].months[1].length * barswidth);
                        }
                    }
                }
                else if(monthLength == 3)
                {
                    m.x = -receivedData[0].months[0].length * barswidth + 30;
                }
                

                dailyVis.transform(m);
                
                dailyVis.render();
            }
            
            var contactsList = %s;
            var contactNameToEmails = %s;
            $("#search").autocomplete({
                source: contactsList,
                select: function(event, ui) 
                {
                    contactSearch(ui.item.value);
                }
            });
            
            $("#search").live('click', function() {
                $("#search").val("");
            });
            
            
            $( "#dialog:ui-dialog" ).dialog( "destroy" );
    
            $( "#dialog-message" ).dialog({
                width:"auto",
                modal: true,
                autoOpen: false,
                buttons: {
                    Ok: function() {
                        $('#names :checked').each(function() {
                            if(!isContactSelected($(this).val()))
                            {
                                contactSelected($(this).val());
                            }
                        });
                        
                        $('#names :not(:checked)').each(function() {
                            if(isContactSelected($(this).val()))
                            {
                                contactSelected($(this).val());
                            }
                        });
                        
                        reRender();
                        $( this ).dialog("close");
                    }
                }
            });
        </script>
        
        
        <script type="text/javascript">
            function drawCloud(word_list) {
                $("#tagCloud").jQCloud(word_list);
            }
      
            $('.w0, .w1, .w2, .w3, .w4, .w5, .w6, .w7, .w8, .w9, .w10').live('click', function() {
                wordSelected($(this).text());
            });
      
        </script>
    <div id="dialog-message" style="width:auto" title="Multi contacts bar">  
    </div>
    <div id="searchZone" style="width: 100%%; height: 5%%;">
        <!--<div style="float: left;"><label for="search">Search: </label> <input id="search" /></div>-->
        <div style="float: left;"><input id="search" /><button id="search" onclick="var toSearch = $('input#search').val(); if(toSearch.length >0) { contactSearch(toSearch); } else { alert('You should enter a valid name/email on the search box');}">Search</button></div>  
        <div id="selectedZone" style="float: left; margin-left: 10px;"></div> 
        
        <form method="post" action="logout_action">
            <button id="logout" style="float:right">Logout</button>
            <label style="float:right; line-height: 25px; margin-right:10px">%s</label>
        </form>
        
    </div>
    <div id="timeLine" style="width: 100%%; height: 54%%; border: 1px solid #ccc; margin-bottom:0.3%%">
        <script type="text/javascript+protovis">
            
            var vis = new pv.Panel()
                    .width(width)
                    .height(height)
                    .fillStyle("#EEE")
                    .event("mousedown", (pv.Behavior.pan().bound(true)))
                    .event("pan", function() mouseDownFlag = true)
                    .def("selectedContacts", selectedContacts)
                    .def("selectedWords", selectedWords)
                    ;
            var receivedTimeLineData = %s;
            var sentTimeLineData = %s;
            var contactsKeywords = %s;
            drawTimeLine(receivedTimeLineData, sentTimeLineData);
            var dailyReceivedTimeline = %s;
            var dailySentTimeline = %s;
            var geralKeywords = %s;
        </script>
    </div>
    
    <div style="width: 100%%; height: 40%%">
        <div id="timeLine2-holder" style="width: 49.8%%; height: 100%%; float:left;">
            <div id="timeLine2" style="width: 100%%; height: 100%%; border: 1px solid #ccc">
            	<script type="text/javascript+protovis">
	            	var dailyVis = new pv.Panel()
	                    .width(dailyWidth)
	                    .height(dailyHeight)
	                    .fillStyle("#EEE")
	                    .event("mousedown", (pv.Behavior.pan().bound(true)))
	                    .event("pan", function() mouseDownFlag = true)
                        .def("selectedContacts", selectedContacts)
                        .def("selectedWords", selectedWords)
	                    ;
                        
	        	</script>
            </div>
        </div>
        <div id="tagCloud-holder" style="width: 49.8%%; height: 100%%; float:right">
            <div id="tagCloud" style="width: 100%%; height: 100%%; border: 1px solid #ccc">
                <script type="text/javascript+protovis">
                    $(document).ready(function() {
                        drawCloud(geralKeywords);
                    });
                </script>
            </div>    
        </div>
    </div>
    <!--
    
    </div>-->    
    </body>
</html>